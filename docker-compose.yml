networks:
  5g-core-net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.53.1.0/24

services:
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    hostname: mongodb
    networks:
      5g-core-net:
        ipv4_address: 10.53.1.5
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=5gcore
    volumes:
      - mongodb-data:/data/db
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  nrf:
    build:
      context: ./nrf
      dockerfile: ../docker/nrf/Dockerfile
    container_name: nrf
    hostname: nrf
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      5g-core-net:
        ipv4_address: ${NRF_IP}
    ports:
      - "8082:8080"
    volumes:
      - ./config/nrf:/app/config:ro
    environment:
      - NODE_ENV=production
      - CONFIG_PATH=/app/config/config.yaml
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/nnrf-nfm/v1/nf-instances"]
      interval: 10s
      timeout: 5s
      retries: 5

  ausf:
    build:
      context: ./ausf
      dockerfile: ../docker/ausf/Dockerfile
    container_name: ausf
    hostname: ausf
    depends_on:
      mongodb:
        condition: service_healthy
      nrf:
        condition: service_healthy
    networks:
      5g-core-net:
        ipv4_address: ${AUSF_IP}
    ports:
      - "8081:8080"
    env_file:
      - ./config/ausf/.env
    restart: unless-stopped

  udm:
    build:
      context: ./udm
      dockerfile: ../docker/udm/Dockerfile
    container_name: udm
    hostname: udm
    depends_on:
      mongodb:
        condition: service_healthy
      nrf:
        condition: service_healthy
    networks:
      5g-core-net:
        ipv4_address: ${UDM_IP}
    ports:
      - "8084:8080"
    env_file:
      - ./config/udm/.env
    restart: unless-stopped

  nssf:
    build:
      context: ./nssf
      dockerfile: ../docker/nssf/Dockerfile
    container_name: nssf
    hostname: nssf
    depends_on:
      mongodb:
        condition: service_healthy
      nrf:
        condition: service_healthy
    networks:
      5g-core-net:
        ipv4_address: ${NSSF_IP}
    ports:
      - "8083:8080"
    env_file:
      - ./config/nssf/.env
    restart: unless-stopped

  amf:
    build:
      context: ./amf
      dockerfile: ../docker/amf/Dockerfile
    container_name: amf
    hostname: amf
    depends_on:
      nrf:
        condition: service_healthy
      ausf:
        condition: service_started
      udm:
        condition: service_started
      nssf:
        condition: service_started
    networks:
      5g-core-net:
        ipv4_address: ${AMF_IP}
    ports:
      - "8086:8000"      
      - "38412:38412/sctp" 
    volumes:
      - ./config/amf:/app/config:ro
    command: ["/app/amf", "--config", "/app/config/amfcfg.json"]
    environment:
      - RUST_LOG=debug
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.sctp.rto_min=200
      - net.sctp.rto_initial=1000
      - net.sctp.rto_max=2000

  smf:
    build:
      context: ./smf
      dockerfile: ../docker/smf/Dockerfile
    container_name: smf
    hostname: smf
    depends_on:
      mongodb:
        condition: service_healthy
      nrf:
        condition: service_healthy
      udm:
        condition: service_started
    networks:
      5g-core-net:
        ipv4_address: ${SMF_IP}
    ports:
      - "8085:8080"     
      - "8805:8805/udp" 
    env_file:
      - ./config/smf/.env
    restart: unless-stopped
    cap_add:
      - NET_ADMIN

  upf:
    build:
      context: ./upf
      dockerfile: ../docker/upf/Dockerfile
    container_name: upf
    hostname: upf
    depends_on:
      nrf:
        condition: service_healthy
      smf:
        condition: service_started
    networks:
      5g-core-net:
        ipv4_address: ${UPF_IP}
    ports:
      - "8087:8080"     
      - "2152:2152/udp" 
      - "8806:8806/udp" 
    volumes:
      - ./upf/config.yaml:/app/config.yaml:ro
    environment:
      - RUST_LOG=info
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1

  ueransim-gnb:
    build:
      context: .
      dockerfile: ./docker/ueransim/Dockerfile
    container_name: ueransim-gnb
    hostname: ueransim-gnb
    depends_on:
      amf:
        condition: service_started
    networks:
      5g-core-net:
        ipv4_address: ${NR_GNB_IP}
    volumes:
      - ./config/ueransim/gnb.yaml:/config/gnb.yaml:ro
      - ./docker/ueransim/start-gnb.sh:/start-gnb.sh:ro
    command: ["/bin/bash", "/start-gnb.sh"]
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    privileged: true
    stdin_open: true
    tty: true

  ueransim-ue:
    build:
      context: .
      dockerfile: ./docker/ueransim/Dockerfile
    container_name: ueransim-ue
    hostname: ueransim-ue
    depends_on:
      ueransim-gnb:
        condition: service_started
    networks:
      5g-core-net:
        ipv4_address: ${NR_UE_IP}
    volumes:
      - ./config/ueransim/ue.yaml:/config/ue.yaml:ro
      - ./docker/ueransim/start-ue.sh:/start-ue.sh:ro
    command: ["/bin/bash", "/start-ue.sh"]
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    privileged: true
    stdin_open: true
    tty: true

  web-ui:
    build:
      context: ./web-ui
      dockerfile: ../docker/web-ui/Dockerfile
    container_name: web-ui
    hostname: web-ui
    networks:
      5g-core-net:
        ipv4_address: 10.53.1.200
    ports:
      - "3001:3000"
    environment:
      - NODE_ENV=production
    restart: unless-stopped

volumes:
  mongodb-data:
